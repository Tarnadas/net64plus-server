language: node_js
node_js:
  - 8.17.0

env:
  global:
    - CXX=g++-4.8

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8

jobs:
  include:
    - stage: Test
      script: jest --coverage --coverageReporters=text-lcov | ./node_modules/coveralls/bin/coveralls.js
      name: "Unit Tests"
    - script: yarn lint
      name: "Lint"
    - script: commitlint-travis
      name: "Lint Commit"
    - stage: Build
      script: yarn build
      name: "Build"
    - stage: Deploy
      script: yarn compile
      name: "Compile & Deploy"
      before_deploy:
        - export PACKAGE_VERSION=$(grep '"version":' package.json -m1 | cut -d\" -f4)
        - export GIT_TAG=$PACKAGE_VERSION-dev.$TRAVIS_BUILD_NUMBER
        - yarn changelog
        - export RELEASE_BODY="$(cat changelog/${PACKAGE_VERSION}.md)"
        - cd compile
        - tar czf net64plus-server_$(echo $PACKAGE_VERSION)_win32-x64.tar.gz net64plus-server_$(echo $PACKAGE_VERSION)_win32-x64.exe
        - tar czf net64plus-server_$(echo $PACKAGE_VERSION)_linux-x64.tar.gz net64plus-server_$(echo $PACKAGE_VERSION)_linux-x64
      after_success:
        - git add changelog
        - git commit -m "docs: update changelog"
        - git tag $GIT_TAG -a -m "Generated tag from TravisCI for build $TRAVIS_BUILD_NUMBER"
        - git push -q https://github.com/Tarnadas/net64plus-server
        - git push -q https://github.com/Tarnadas/net64plus-server --tags
      deploy:
        provider: releases
        api_key:
          secure: jphi6aEJVksJDYZwBfnudcVEl7y34AVtxfui7nNdRXPDG5ez4m9PcdGULNqsadfCKzRMcUdOSPCSjZAMB4+20uPJJFHHmKSbjyuvXHrkR2NiVe1/sLAtsWZUg5GzmY3hg4KEb1Ru8NP7B8w5LjKE31958UM+swUIW+2XtYUPXXWPGd9VXK/5SK6cA80fEBaw9gaZhGPlrtzjGCcP8JpzpsReoCnvkvPvm4eV7gSUFNdiCyROajrERQRKuAN5yzpiEJBvRJKiZClqExbg7Nz5BqyxeVXYeHyn0/rO3Dc/abTrmnM9nKNp3E7GWYgEpirUIliNuTn1/1cU/5jqZUXcbhQ9kaqk4+e4xHZ1bVi9ewuOQKGzbiyff5md8/+nJkFmzMYUuzIlqSUu3WXf+/E/EGOwNLNR0mjlzmi1Ckzm5GHZ58iqXASlA6pS0CP1T4sONtkQ63muIGCEEIQ9jw7I0qA3rU2+53WSpPxW5afTfMPp8Iy6RVv7OBBX+n3yLHVk0u+x3R+SPpifzUueoPWcxtwymoq2U4DLMyLlb2JJtpWARlooyxztqUKKozVOnY/SPaiYzdrI7Mw3DW/RiqCJ3jqZa8/OXWpuEH5F0pWHejFop6VKsOmmRG9EubqxKMiQrk6J1F+CyCCIdWqOzFebj4b4UdACVE5AEAfNXCivqYE=
        file:
          - net64plus-server_$(echo $PACKAGE_VERSION)_win32-x64.tar.gz
          - net64plus-server_$(echo $PACKAGE_VERSION)_linux-x64.tar.gz
        skip_cleanup: true
        draft: true
        name: "Net64+ Server $(echo $PACKAGE_VERSION) [CommitID: $(echo $GIT_TAG)]"
        body: "$(echo $RELEASE_BODY)"
        on:
          repo: Tarnadas/net64plus-server
          branch: master
